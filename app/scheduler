import datetime
from bson import ObjectId

from app.util import slack_msg
from app.util import serialize_doc
from app import mongo

#function for scheduler
def alert():
    today = datetime.datetime.today()
    last_day = today - datetime.timedelta(1)
    next_day = today + datetime.timedelta(1)
    
    # first finding all the user id from reports collection which have created a check-in in last 24 hours
    docs = mongo.db.reports.find({
        "created_at": {
            "$gte": datetime.datetime(last_day.year,last_day.month,last_day.day),
            "$lte": datetime.datetime(next_day.year, next_day.month, next_day.day)
        }
    }, {'user': 1})
    docs = [serialize_doc(doc) for doc in docs]
    data = docs
    # creating a list for saving user id fetched from the above query
    data_list = list()
    for user in data:
        # appending all the user_id from the reports collection and storing it in data_list
        data_list.append(ObjectId(user['user']))
        
    # second what we do is find all the users_id from the user collection which are not present in data_list    
    rets = mongo.db.users.find({'_id': {'$not':{"$in": data_list}}}, {'username': 1})
    rets = [serialize_doc(ret) for ret in rets]
    names = rets
    
    # we save the user data we get from the above query 
    # initialize and empty names_list
    names_list = list()
    # fetch the names from the above user data and save it in names_list()
    for name in names:
        names_list.append(name['username'])
        
    # finally by using webhooks send a msg to TMS channel on slack a message of all the username we get above     
    slack_msg(msg='You have not done check-in of last day : ' + ', '.join(names_list))

